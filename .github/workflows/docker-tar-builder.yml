name: Docker Tar Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name'
        required: true
        default: 'appsmith/appsmith-ce'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 配置国内镜像加速（彻底解决拉取慢/超时）
      - name: Configure Docker mirror (China)
        run: |
          sudo mkdir -p /etc/docker
          echo '{"registry-mirrors": ["https://docker.nju.edu.cn", "https://docker.mirrors.sjtug.sjtu.edu.cn"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker || true

      # 2. 拉取镜像（带重试，确保成功）
      - name: Pull Docker image
        run: |
          for i in {1..3}; do
            docker pull --platform linux/amd64 ${{ github.event.inputs.image_name }} && break || sleep 10;
          done

      # 3. 保存并压缩为单个 .tar.gz 文件（关键改进）
      - name: Save and compress image
        run: |
          docker save ${{ github.event.inputs.image_name }} | gzip > appsmith.tar.gz
          echo "压缩后文件大小："
          ls -lh appsmith.tar.gz

      # 4. 上传压缩包作为 Artifact
      - name: Upload compressed image
        uses: actions/upload-artifact@v4
        with:
          name: appsmith-image
          path: appsmith.tar.gz
          retention-days: 7
          compression-level: 0   # 文件已是 gzip 压缩，禁止二次压缩
